version: "3.3"
services:
  fetch_edit_history:
    build: scripts/edit_history
    volumes:
      - .:/code
    environment:
      - MONGO_URL=mongo:27017
      - MONGO_USERNAME=$MONGO_DB_USER
      - MONGO_PASSWORD=$MONGO_DB_PASS

  jupyter_notebook:
      build: notebooks
      user: root
      working_dir: /home/alejgh/work
      volumes:
        - ./notebooks:/home/alejgh/work
        - ./data:/home/alejgh/data
        - ${LOCAL_SSL_CERTS}:/etc/ssl/notebook
      environment:
        - NB_USER=alejgh
        - CHOWN_HOME=yes
        - RESTARTABLE=yes
        - MONGO_URL=mongo:27017
        - MONGO_USERNAME=$MONGO_DB_USER
        - MONGO_PASSWORD=$MONGO_DB_PASS
      ports:
        - 8888:8888
      command: "start-notebook.sh \
        --ServerApp.password=${NOTEBOOK_TOKEN} \
        --ServerApp.certfile=/etc/ssl/notebook/jupyter.pem"

  mongo:
    image: mongo
    restart: always
    environment:
      - MONGO_INITDB_ROOT_USERNAME=$MONGO_ROOT_USER
      - MONGO_INITDB_ROOT_PASSWORD=$MONGO_ROOT_PASS
      - MONGO_INITDB_USERNAME=$MONGO_DB_USER
      - MONGO_INITDB_PASSWORD=$MONGO_DB_PASS
      - MONGO_INITDB_DATABASE=wd_diff
    ports:
      - 27017:27017
    volumes:
      - mongodata:/data/db
      - ./config/init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh

  mongo-express:
    image: mongo-express
    restart: always
    ports:
      - 8081:8081
    environment:
      - ME_CONFIG_MONGODB_ADMINUSERNAME=$MONGO_EXPRESS_USER
      - ME_CONFIG_MONGODB_ADMINPASSWORD=$MONGO_EXPRESS_PASS
      - ME_CONFIG_MONGODB_URL=mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASS}@mongo:27017/
    depends_on:
      - "mongo"

volumes:
  mongodata:
